# 🎯 期权蝴蝶策略量化模型完整总结

## 一、核心问题与解决方案

### **1. 理论定价 vs 市场定价的权衡**

**核心矛盾：**
- Black-Scholes模型基于理想假设（恒定波动率、无交易成本、连续交易）
- 真实市场存在流动性约束、Bid-Ask价差、IV Skew

**最终方案：**
```
定价策略 = 市场价格为主 + BS模型为辅助验证

具体权重：
- |偏差| < 10%  → 完全相信市场价格
- 10% < |偏差| < 20% → 警惕，检查是否有重大事件
- |偏差| > 20% → 怀疑数据质量，或存在套利机会

动态加权：
加权价格 = (流动性评分 × 市场价格) + ((1-流动性评分) × BS价格)
```

**为什么不能完全依赖BS模型？**
- 市场价格反映了真实的供需关系和未来预期
- BS模型只是理论锚点，帮助识别定价异常

---

## 二、IV Skew（波动率偏斜）的关键性

### **2.1 为什么必须考虑IV Skew？**

**错误做法：**
```
对所有行权价使用同一个波动率 σ_GARCH = 25%

结果：
- 低估了OTM Put的价格（实际IV可能是28%）
- 高估了OTM Call的价格（实际IV可能是23%）
- 导致蝴蝶策略定价误差高达20%
```

**正确做法：**
```
IV Skew结构（典型股票）：

行权价        钱性      市场IV    调整系数
$450 (OTM Put)  95%      28%       +12%
$475 (ATM)      100%     25%       基准
$500 (OTM Call) 105%     23%       -8%

原因：
- OTM Put: 投资者买Put保护 → 需求高 → IV高
- OTM Call: 投机需求弱 → IV低
```

**对蝴蝶策略的影响：**
```
Long Call Butterfly: K1=$470, K2=$480, K3=$490

不考虑Skew（错误）：
  BS(470, σ=25%) = $12.50
  BS(480, σ=25%) = $8.00
  BS(490, σ=25%) = $4.50
  理论成本 = $1.00

考虑Skew（正确）：
  BS(470, σ=26%) = $13.00  ← ITM区域IV略高
  BS(480, σ=25%) = $8.00
  BS(490, σ=24%) = $4.20   ← OTM Call IV低
  实际成本 = $1.20

误差 = 20%！
```

---

## 三、傅立叶分析的正确姿势

### **3.1 最大陷阱：直接对价格做FFT**

**为什么错误？**
```
价格序列的数学问题：

P(t) = Trend(t) + Cycle(t) + Noise(t)

问题1：非平稳性
- 价格有上涨/下跌趋势
- 傅立叶假设信号统计特性稳定
- 趋势项会产生虚假的低频能量

问题2：单位根
- 价格是随机游走 P(t) = P(t-1) + ε(t)
- 频谱呈现 S(f) ∝ 1/f²（粉红噪声）
- 无法区分真实周期 vs 随机波动
```

### **3.2 正确的去趋势方法**

**方法1：相对VWAP的偏移（推荐用于检测机构行为）**
```python
VWAP = Σ(Price × Volume) / Σ(Volume)  # 成交量加权均价

去趋势信号 = Price(t) - VWAP(t)

数学意义：
- VWAP是低频滤波器，自动过滤高频噪音
- 去趋势后的信号更接近平稳过程
- 适合检测"围绕VWAP的周期性波动"（机构拆单特征）
```

**方法2：对数收益率（标准金融方法）**
```python
r(t) = log(P(t) / P(t-1))

优点：
- 天然平稳
- 无量纲（可跨资产比较）
- 符合几何布朗运动假设
```

**方法3：分析成交量节奏（检测机构行为）**
```python
直接对成交量做FFT：

v(t) = Volume(t)

为什么有效：
- 机构算法拆单会留下"节奏"
- 成交量本身是平稳的（无趋势）
- 如果发现固定频率的能量峰 → 算法执行痕迹
```

### **3.3 傅立叶在期权策略中的实际用途**

**不是用来预测，而是用来侦测：**
```
侦测1：市场中是否存在"非自然的节奏"
- 大型机构
- 算法拆单（VWAP/TWAP执行）
- 如果发现：某频率能量持续高于阈值 → 机构在执行

侦测2：主导周期识别
- 如果检测到28天周期
- 选择DTE=30天的蝴蝶期权
- 期权到期时正好处于周期高点/低点

侦测3：趋势 vs 盘整
- 低频能量 (>60天) → 趋势
- 中频能量 (7-60天) → 周期性盘整
- 高频能量 (<7天) → 噪音

策略映射：
- 趋势 + 周期底部 → Call Butterfly
- 趋势 + 周期顶部 → Put Butterfly
- 盘整 → Iron Butterfly
```

**权重分配建议：**
```
在综合评分中：
- ARIMA价格预测：35%  ← 主要信号
- GARCH波动率：30%     ← 核心因子
- 傅立叶周期：15%      ← 辅助决策
- 流动性/Greeks：20%

原因：
- 傅立叶需要大量历史数据（60天+）
- 在个股上不如指数稳定
- 但可以帮助避开高频波动期、选择合适DTE
```

---

## 四、回测框架设计的现实约束

### **4.1 yfinance的数据限制**

```
可获取：
✅ 历史股价（日级、分钟级）
✅ 当前期权链快照（Strike, Bid, Ask, IV, Volume, OI）
✅ 无风险利率（从^IRX推断）

无法获取：
❌ 历史期权链（只有当日）
❌ 逐笔Tick数据
❌ 历史Bid-Ask Spread
❌ 真实的成交时机

结论：只能做"日级回测"，无法模拟盘中动态
```

### **4.2 合成市场数据的方案**

**核心思路：从有限数据推断统计分布**

```
步骤1：预先收集真实市场统计（一次性）
从最近1个月的期权链收集：
- Bid-Ask Spread分布（按钱性分类）
  - OTM: mean=10%, std=3%
  - ATM: mean=5%, std=2%
  - ITM: mean=7%, std=2.5%
- 流动性分布（Volume, Open Interest）

步骤2：回测时为历史每天合成期权链
for 历史每一天:
  1. 用BS模型计算理论价格（基于历史波动率）
  2. 叠加合成的Bid-Ask Spread
     - 从统计分布中采样
     - Spread ~ LogNormal(μ, σ)
  3. 叠加流动性约束
     - Volume ~ LogNormal(base_volume, 0.5)
  4. 调整IV Skew
     - 根据钱性调整波动率

步骤3：模拟执行
实际成交价 = Mid Price + Slippage

买入：Ask + ε
卖出：Bid - ε

其中 ε = 市场冲击成本 = λ × sqrt(订单量/日均量)
```

### **4.3 滑点建模的数学分解**

```
总滑点 = Fixed_Spread + Market_Impact + Adverse_Selection

1. Fixed Spread（固定价差）
   = (Ask - Bid) / 2
   - OTM期权: 8-10%
   - ATM期权: 5-7%
   - 从真实数据拟合对数正态分布

2. Market Impact（市场冲击）
   Kyle's Lambda模型：
   Impact = λ × sqrt(OrderSize / ADV) × VolatilityFactor
   
   典型参数：
   - λ = 0.05 ~ 0.15（期权流动性差）
   - ADV = Average Daily Volume

3. Adverse Selection（逆向选择）
   - 大单会暴露意图
   - 造市商会调整报价
   - 通常包含在Market Impact中

蝴蝶策略的总成本：
TotalCost = Σ[(Ask_i - Bid_i)/2] + MarketImpact + 佣金
```

### **4.4 流动性约束建模**

```
流动性分级：

Tier 1 (优秀): Spread < 5%, Volume > 500
  → 可以执行任何评分>70的策略

Tier 2 (良好): 5% < Spread < 10%, Volume > 200
  → 仅执行评分>80的策略（补偿流动性成本）

Tier 3 (可接受): 10% < Spread < 15%, Volume > 100
  → 仅执行评分>90的策略（必须是极优机会）

Tier 4 (拒绝): Spread > 15% 或 Volume < 100
  → 完全放弃，无论价格多诱人

回测中的判断：
def can_execute_butterfly(volumes, open_interests):
    # 经验规则：单日成交量 < 持仓量的10%
    daily_liquidity = min(volume * 0.10, OI * 0.05)
    
    if daily_liquidity < 10:
        return False  # 流动性太差，拒绝
    
    # 蝴蝶需要3个行权价都能成交
    for each leg:
        if not enough_liquidity:
            return False
    
    return True
```

---

## 五、综合评分系统的设计哲学

### **5.1 为什么用规则+评分，而非纯ML？**

```
场景判断：

适合规则系统：
✅ 单一股票（数据量有限）
✅ 需要可解释性（告诉用户"为什么"）
✅ 快速上线（无需训练数据）
✅ 稳定可靠（不会过拟合）

适合机器学习：
✅ 跨100+个股票寻找机会
✅ 需要自适应不同市场状态
✅ 有大量历史交易数据
✅ 可容忍黑盒决策

你的产品定位：
- 前端工具
- 单一股票分析
- 用户需要理解逻辑
→ 规则+评分系统是最佳选择
```

### **5.2 多因子评分公式**

```
Score = w1×Price_Factor + w2×Vol_Factor + w3×Liquidity_Factor + w4×Fourier_Factor

因子1：价格预测匹配度（35%权重）
Price_Factor = max(0, 100 - |ARIMA预测 - K2| / K2 × 500)

意义：
- 中心行权价越接近预测价格，评分越高
- 如果预测$480，中心定在$480 → 满分
- 如果预测$480，中心定在$490 → 扣分

因子2：波动率错误定价（30%权重）
Vol_Factor = min(100, (IV_market - σ_GARCH) / IV_market × 500)

意义：
- IV被高估 → 卖期权有利 → 蝴蝶策略获利
- 如果IV=30%, GARCH预测25% → IV高估16.7% → 高分
- 如果IV=20%, GARCH预测25% → IV低估 → 低分

因子3：价格稳定性（20%权重）
Stability_Factor = max(0, 100 - PriceRange/Forecast × 500)

意义：
- ARIMA置信区间越窄 → 价格越稳定 → 蝴蝶越有利
- 如果95%CI = ±2% → 高分
- 如果95%CI = ±15% → 低分

因子4：傅立叶周期对齐（15%权重）
Fourier_Factor = 
  100  if (趋势UP + 周期底部 + Call Butterfly) 或
          (趋势DOWN + 周期顶部 + Put Butterfly) 或
          (趋势FLAT + Iron Butterfly)
  50   otherwise

意义：
- 策略类型与市场状态完美匹配 → 满分
- 不匹配 → 扣分

Greeks惩罚：
Delta_Penalty = min(10, |Delta| × 50)
Total_Score = Total_Score - Delta_Penalty

意义：
- 蝴蝶应该Delta中性
- 如果|Delta| > 0.15 → 有方向性风险 → 扣分
```

### **5.3 评分到推荐的映射**

```
推荐逻辑：

Score >= 75 且 ProfitRatio > 2  → STRONG_BUY
  - 所有条件优秀
  - 盈亏比足够吸引
  - 建议仓位：3-5%

60 <= Score < 75 且 ProfitRatio > 1.5  → BUY
  - 条件良好
  - 风险可控
  - 建议仓位：2-3%

45 <= Score < 60  → NEUTRAL
  - 条件一般
  - 观望或小仓位测试
  - 建议仓位：1-2%

Score < 45  → AVOID
  - 条件不满足
  - 避免交易
```

---

## 六、Greeks的风险管理意义

### **6.1 蝴蝶策略的Greeks特征**

```
理想的蝴蝶策略：

Delta ≈ 0
- 方向中性
- 不受小幅价格波动影响
- 如果|Delta| > 0.15 → 存在方向性赌注 → 风险

Gamma > 0（在中心附近）
- 价格接近中心时Gamma为正
- 意味着价格越接近K2，获利加速
- 但远离K2时Gamma为负（风险加大）

Vega < 0
- 做空波动率
- IV下降时获利
- 适合在IV高位（>75百分位）入场
- 如果IV飙升30% → 策略亏损

Theta > 0
- 时间是朋友
- 每天赚取时间价值衰减
- 典型：每天+$0.05 ~ $0.15
- 适合盘整市场

综合特征：
蝴蝶 = 做多时间价值衰减 + 做空波动率 + 赌价格在区间内
```

### **6.2 Greeks在评分中的应用**

```
风险评估逻辑：

基础风险：
- 价格稳定性 + 波动率溢价 → LOW/MEDIUM/HIGH

Greeks调整：
if |Delta| > 0.15:
    风险等级 += 1  # LOW → MEDIUM, MEDIUM → HIGH
    
if Vega > -0.5:  # Vega应该明显为负
    风险等级 += 1
    
if IV_percentile < 50:  # IV不在高位
    风险等级 += 1

评分惩罚：
Delta_Penalty = min(10, |Delta| × 50)
Final_Score = Score - Delta_Penalty

意义：
- 确保策略保持Delta中性
- 如果Delta偏离，即使其他条件好也要扣分
```

---

## 七、机器学习的定位（可选未来方向）

### **7.1 如果引入ML，应该怎么做？**

**特征工程：**
```
时间序列特征（40%）：
- ARIMA预测值、置信区间、模型AIC
- GARCH波动率预测、历史分位数
- 傅立叶主周期、周期强度

期权微观结构（35%）：
- IV Skew (ATM, OTM Call, OTM Put)
- Bid-Ask Spread平均值
- 流动性评分（Volume × OI）
- Greeks (Delta, Gamma, Vega, Theta)

市场环境（25%）：
- VIX水平及分位数
- SPY相关性
- 市场regime (bull/bear/sideways)
- RSI, MACD等技术指标

标签设计：
y = (Exit_Value - Entry_Cost) / Entry_Cost  # 回报率

或：
y = Return / MaxLoss  # 风险调整后回报（更好）
```

**模型选择：XGBoost**
```
为什么不用LSTM？
1. 已经有ARIMA/GARCH提取了时序信息
2. XGBoost对表格数据效果更好
3. 可解释性强（SHAP值）
4. 训练快，不易过拟合
5. 对数据量要求相对低

XGBoost配置：
max_depth = 5  # 不要太深，避免过拟合
learning_rate = 0.05
n_estimators = 100
subsample = 0.8  # 防止过拟合
```

**分阶段实现：**
```
阶段1（现在）：纯规则系统
- 快速上线
- 完全可解释
- 易于调试

阶段2（3个月后）：ML增强
- 收集真实交易数据
- 训练XGBoost
- ML预测作为额外信号

Score = 0.30 × RuleScore + 0.40 × MLScore + 0.30 × UserPreference

阶段3（长期）：在线学习
- 根据实盘结果持续更新
- A/B测试不同策略
- 个性化推荐
```

---

## 八、核心数学模型总结

### **完整决策公式：**

```
最优蝴蝶策略 = argmax{
  Score(K1, K2, K3) = 
    0.35 × [100 - |ARIMA预测 - K2| / K2 × 500] +
    0.30 × [min(100, (IV - σ_GARCH) / IV × 500)] +
    0.20 × [100 - (CI宽度 / 预测值) × 500] +
    0.15 × Fourier_Alignment
    - Delta_Penalty
}

约束条件：
1. K2 ∈ [ARIMA预测 - 1.5σ, ARIMA预测 + 1.5σ]
2. NetDebit > 0
3. Bid-Ask Spread < 10%
4. Volume > 100 contracts
5. DTE ∈ [21, 45] days
6. |Delta(蝴蝶)| < 0.10
7. Vega(蝴蝶) < 0
8. IV_percentile > 50%

风险管理：
- 止损：-50%成本
- 止盈：+70%最大收益
- 时间止损：DTE < 7天强制平仓
- 波动率止损：IV飙升>30%退出
```

---

## 九、关键Insights与经验总结

### **9.1 定价原则**

1. **市场价格 > 理论价格**：市场价格反映真实供需，BS只是参考
2. **IV Skew不可忽视**：不同行权价必须用不同波动率
3. **流动性是硬约束**：价格再好，流动性差也不能交易

### **9.2 傅立叶分析**

1. **必须去趋势**：直接对价格做FFT是错误的
2. **检测而非预测**：用于识别周期和机构行为，不是预测工具
3. **权重适中**：15%权重，作为辅助决策

### **9.3 回测设计**

1. **现实主义**：接受yfinance的限制，用合成数据补充
2. **保守估计**：宁可高估滑点，也不要过拟合
3. **流动性优先**：评分再高，流动性不够也要拒绝

### **9.4 评分系统**

1. **可解释性**：每个因子都有明确的金融含义
2. **动态权重**：可根据市场状态调整
3. **Greeks约束**：确保策略保持中性特征

### **9.5 风险管理**

1. **仓位控制**：评分>75才考虑3-5%仓位
2. **多重止损**：价格、时间、波动率三重防线
3. **Greeks监控**：Delta偏离立即调整

---

## 十、实战建议优先级

### **立即实现（P0）：**
1. ✅ 真正的傅立叶去趋势（VWAP或收益率）
2. ✅ Black-Scholes精确定价
3. ✅ IV Skew调整
4. ✅ Greeks计算
5. ✅ 综合评分系统

### **重要改进（P1）：**
1. ⏳ 回测框架（合成市场数据）
2. ⏳ 滑点建模（三因子分解）
3. ⏳ 流动性过滤
4. ⏳ ARIMA自动选参

### **锦上添花（P2）：**
1. 🔮 机器学习增强（3个月后）
2. 🔮 多策略组合
3. 🔮 实时监控与预警
4. 🔮 个性化推荐

---

## 结语

这个模型的核心哲学是：

> **在有限数据和现实约束下，构建一个"足够好"的量化决策系统**

- 不追求完美的预测（那是不可能的）
- 而是通过多因子综合评估，识别"高概率"机会
- 结合严格的风险管理，实现长期稳定收益

关键是：**可解释、可验证、可优化**。